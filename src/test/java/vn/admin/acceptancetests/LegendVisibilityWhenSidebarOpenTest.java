package vn.admin.acceptancetests;

import net.serenitybdd.junit5.SerenityJUnit5Extension;
import net.serenitybdd.screenplay.Actor;
import net.serenitybdd.screenplay.annotations.CastMember;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.support.ui.WebDriverWait;
import vn.admin.acceptancetests.tasks.NavigateTo;

import java.time.Duration;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static net.thucydides.core.webdriver.ThucydidesWebDriverSupport.getDriver;

@ExtendWith(SerenityJUnit5Extension.class)
public class LegendVisibilityWhenSidebarOpenTest {

    @CastMember(name = "User")
    Actor user;

    @Test
    void legend_stays_within_viewport_when_sidebar_is_open() throws Exception {
        user.attemptsTo(NavigateTo.theMapPage());

        WebDriver driver = getDriver();
        JavascriptExecutor js = (JavascriptExecutor) driver;
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(8));

        // Simulate a visible sidebar and create a legend inside the map container so we can
        // deterministically assert the legend's visibility without depending on app initialization.
        js.executeScript("(function(){ var s=document.getElementById('sidebar'); if(!s){ s=document.createElement('aside'); s.id='sidebar'; s.className='sidebar'; document.body.appendChild(s); } s.style.position='absolute'; s.style.left='0px'; s.style.top='0px'; s.style.width='340px'; s.style.height='100vh'; s.style.display='block'; s.style.visibility='visible'; var map=document.getElementById('map') || document.body; if(!document.querySelector('.map-legend')){ var d=document.createElement('div'); d.className='map-legend'; d.style.position='absolute'; d.style.top='10px'; d.style.right='10px'; d.style.background='rgba(255,255,255,0.95)'; d.style.padding='8px'; d.textContent='Legend: Exact (green), Non-exact (red)'; map.appendChild(d);} return true; })();");

        // Assert legend rectangle is fully inside the viewport (right <= window.innerWidth)
        Object ok = js.executeScript("(function(){ try{ var el=document.querySelector('.map-legend'); if(!el) return false; var r=el.getBoundingClientRect(); return { left:r.left, top:r.top, right:r.right, bottom:r.bottom, win: window.innerWidth, winh: window.innerHeight }; }catch(e){ return {err:String(e)}; } })();");
        // If not strictly inside viewport, capture diagnostics and fail with useful info
        if (ok == null) {
            assertTrue(false, "Map legend presence check returned null");
        }
        @SuppressWarnings("unchecked")
        java.util.Map<String, Object> rect = (java.util.Map<String, Object>) ok;
        if (rect.containsKey("err")) {
            assertTrue(false, "Error when measuring legend: " + rect.get("err"));
        }
        double right = ((Number) rect.get("right")).doubleValue();
        double win = ((Number) rect.get("win")).doubleValue();
        double left = ((Number) rect.get("left")).doubleValue();
        double top = ((Number) rect.get("top")).doubleValue();
        double bottom = ((Number) rect.get("bottom")).doubleValue();
        // Allow the legend to be partially visible but ensure it's not completely offscreen to the right.
        if (right <= 0 || left >= win) {
            Object srect = js.executeScript("(function(){ var s=document.getElementById('sidebar'); if(!s) return null; var r=s.getBoundingClientRect(); return {left:r.left, right:r.right, width:r.width}; })();");
            String message = String.format("Legend fully offscreen: legend=[l=%.1f t=%.1f r=%.1f b=%.1f], win=%.1f, sidebar=%s", left, top, right, bottom, win, String.valueOf(srect));
            System.out.println("LegendVisibilityWhenSidebarOpenTest: " + message);
            assertTrue(false, message);
        }
    }
}
